<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载中...</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <iframe id="embeddedPage" src=""></iframe>
    <script>
        function getQueryParam(param) {
            return new URLSearchParams(window.location.search).get(param);
        }
        function decodeBase64Url(encodedUrl) {
            return decodeURIComponent(atob(encodedUrl.replace(/-/g, '+').replace(/_/g, '/')));
        }

        const encodedUrl = getQueryParam('y');
        if (encodedUrl) {
            let decodedUrl = decodeBase64Url(encodedUrl);
            
            // 1. 自动适配 iframe 链接的协议（优先 HTTPS，兼容 HTTP）
            // 如果解码后的链接是 HTTP，尝试转为 HTTPS 并检测是否可用
            if (decodedUrl.startsWith('http://')) {
                const httpsUrl = decodedUrl.replace('http://', 'https://');
                // 用 HEAD 请求检测目标是否支持 HTTPS（避免跨域限制，使用 no-cors 模式）
                fetch(httpsUrl, { method: 'HEAD', mode: 'no-cors' })
                    .then(() => {
                        // 支持 HTTPS，使用 HTTPS 链接
                        decodedUrl = httpsUrl;
                    })
                    .catch(() => {
                        // 不支持 HTTPS，保持 HTTP 链接（仅在当前页面是 HTTP 时可用）
                        console.log('目标不支持 HTTPS，保持 HTTP 链接');
                    })
                    .finally(() => {
                        document.getElementById('embeddedPage').src = decodedUrl;
                    });
            } else {
                // 已为 HTTPS 或其他协议，直接使用
                document.getElementById('embeddedPage').src = decodedUrl;
            }

            // 2. 代理地址使用相对协议（自动适配当前页面的 HTTP/HTTPS）
            // 去掉协议前缀，用 "//" 开头，自动继承当前页面的协议
            const PROXY_URL = '//dingun.me/Yao/proxy.php'; 

            // 3. 发起代理请求时，确保协议与当前页面一致
            fetch(`${PROXY_URL}?url=${encodeURIComponent(decodedUrl)}`)
                .then(res => {
                    if (!res.ok) throw new Error('代理请求失败');
                    return res.json();
                })
                .then(data => {
                    document.title = data.title || '在线客服';
                })
                .catch(() => {
                    document.title = '在线客服';
                    console.error('获取标题失败，使用默认标题');
                });
        } else {
            document.body.innerHTML = '<p>错误：缺少必要参数 y</p>';
        }
    </script>
</body>
</html>
